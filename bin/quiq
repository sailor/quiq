#!/usr/bin/env ruby

require_relative '../lib/quiq'
require 'optparse'

options = {}
OptionParser.new do |opts|
  opts.banner = "Usage: quiq [options]"

  opts.on("-p", "--path [PATH|DIR]", "Location of the workers to require") do |path|
    options[:path] = path
  end

  opts.on "-v", "--version", "Output version and exit" do |arg|
    puts "Quiq #{Quiq::VERSION}"
    exit
  end

  opts.on_tail("-h", "--help", "Show this message") do
    puts opts
    exit
  end
end.parse!

begin
  # Lookup for workers in the given path or the current directory
  path = options[:path] || Dir.pwd
  if File.directory?(path)
    Dir.glob(File.join(path, '*.rb')).each { |file| require file }
  else
    require path
  end

  Quiq.run
rescue
  warn $!.message
  warn $!.backtrace.join("\n")
  exit 1
end
